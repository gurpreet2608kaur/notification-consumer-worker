// ingestionController.js
import { createNotification } from "../helpers/postgres.js";
import { sendToDurableObjectQueue, hasScheduleTime } from "../helpers/durable.js";

export async function queueConsumer(batch, env) {
  console.log(`üîÑ Processing ${batch.messages.length} messages from queue`);

  for (const msg of batch.messages) {
    try {
      const notificationData = msg.body;
      console.log("üì• Processing message:", notificationData);

      // 1. Save into PostgreSQL
      const dbResult = await createNotification(env, notificationData);
      console.log("üì• Queue -> DB response:", dbResult);

      // 2. If scheduled ‚Üí also store in Durable Object
      if (hasScheduleTime(notificationData)) {
        console.log("‚è∞ Scheduled notification detected, sending to Durable Object first");
        await sendToDurableObjectQueue(env, notificationData);
        console.log("‚úÖ Notification stored in DO and DB:", msg.id);
      } else {
        // No schedule_time ‚Üí leave empty
      }

      // Acknowledge the message so it‚Äôs removed
      msg.ack();
    } catch (err) {
      console.error("‚ùå Failed to process message:", err);
      // Optional: msg.nack() to retry later
    }
  }

  console.log("üéâ Finished processing queue batch");
}
